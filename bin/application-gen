#!/usr/bin/env php
<?php

require "header.php";

$root = PATH_APPS . "/";
$config = APPLICATION_BUILD;

$doc = new DomDocument();
$doc->xmlVersion    = "1.0";
$doc->formatOutput  = true;
$doc->encoding      = 'UTF-8';

$root_node = $doc->createElement("applications");

if ( $dh  = opendir($root) ) {
  while (false !== ($filename = readdir($dh))) {
    if ( preg_match("/^(Application|System)(.*)(\.glade)$/", $filename) ) {
      echo "Building {$filename}...\n";

      $cname = str_replace(".glade", "", $filename);

      if ( constant("{$cname}::APPLICATION_ENABLED") === false ) {
        echo "\tNot enabled!\n";
        continue;
      }

      if ( $glade = Glade::convert($root . $filename) ) {
        $html    = $glade->__toDocumentString();
        $window  = $glade->getApplicationProperties();
        $signals = $glade->getApplicationSignals();

        $js_methods = "";
        $js_run = "";

        foreach ( $signals as $obj => $evs ) {
          foreach ( $evs as $ev_type => $ev_handler ) {
            $js_methods .= <<<EOJAVASCRIPT

      Event{$ev_handler} : function(ev) {

      },


EOJAVASCRIPT;


            $js_run .= <<<EOJAVASCRIPT

        el.find(".{$obj}").bind("{$ev_type}").function(ev) {
          self.Event{$ev_handler}(ev);
        },

EOJAVASCRIPT;

          }
        }

        $js     = <<<EOJAVASCRIPT
/**
 * Application: {$cname}
 *
 * @package ajwm.Applications
 * @author Anders Evenrud <andersevenrud@gmail.com>
 * @class
 */
var {$cname} = (function(\$, undefined) {
  return function(Application, app, api, argv) {
    var _{$cname} = Application.extend({
      init : function() {
        this._super("{$cname}");
      },

      destroy : function() {
        this._super();
      },

%s

      run : function() {
        var el = app.\$element;

%s

        this._super();
      }
    });

    return new _{$cname}();
  };
})(\$);
EOJAVASCRIPT;

        if ( !$window['title'] ) {
          $window['title'] = constant("{$cname}::APPLICATION_TITLE");
        }
        if ( !$window['icon'] ) {
          $window['icon'] = constant("{$cname}::APPLICATION_ICON");
        }


        $node = $doc->createElement("application");
        $node->setAttribute("class", $cname);
        $node->setAttribute("type", constant("{$cname}::APPLICATION_SYSTEM") ? "system" : "normal");

        $p_html = $doc->createElement("property");
        $p_html->setAttribute("name", "html");
        $p_html->appendChild($doc->createCDATASection($html));

        $p_window = $doc->createElement("property");
        $p_window->setAttribute("name", "window");
        $p_window->appendChild(new DomText(json_encode($window)));

        $p_js = $doc->createElement("property");
        $p_js->setAttribute("name", "javascript");
        $p_js->appendChild($doc->createCDATASection(sprintf($js, $js_methods, $js_run)));

        $node->appendChild($p_window);
        $node->appendChild($p_html);
        $node->appendChild($p_js);

        $root_node->appendChild($node);
        echo "\tSuccess!\n";
      } else {
        echo "\tFailed!\n";
      }

    }
  }
}
$doc->appendChild($root_node);

$xml = $doc->saveXML();
file_put_contents($config, $xml);

?>
