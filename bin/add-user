#!/usr/bin/env php
<?php

require "header.php";

///////////////////////////////////////////////////////////////////////////////
// DEFAULTS
///////////////////////////////////////////////////////////////////////////////

$username   = null;
$password   = null;
$privilege  = 130;
$name       = "John Doe";

///////////////////////////////////////////////////////////////////////////////
// COMMAND LINE PARSING
///////////////////////////////////////////////////////////////////////////////

function my_exit($message) {
  $help = <<<EOTXT
$message

Add a new user to Database and VFS. Usage:
./bin/add-user [arguments,]
-u --username  Username
-p --password  Password
-g --groups    User Groups (Default = 130 [User+Packages])
                  0 = None
                  1 = Guest
                  2 = User
                  4 = Admin
                  128 = Packages
-n --name      Real Name (Default = John Doe)

EOTXT;

  print $help;
  exit(1);
}

$sopts = "u:p:g::n::";
$aopts = Array(
  "username:",
  "password:",
  "groups::",
  "name::"
);


$options = getopt($sopts, $aopts);

if ( sizeof($options) < 2 ) {
  my_exit("Not enough arguments given!");
}

foreach ( $options as $k => $v ) {
  switch ( $k ) {
    case "u" :
    case "username":
      $username = $v;
    break;
    case "p" :
    case "password" :
      $password = $v;
    break;
    case "g" :
    case "groups" :
      $privilege = (int) $v;
    break;
    case "n" :
    case "name" :
      $name = $v;
    break;
  }
}

if ( !$username || !$password || !is_numeric($privilege) || !$name ) {
  my_exit("Invalid or missing arguments...");
}

print <<<EOTXT
Using arguments:

  username  = $username
  password  = $password
  privilege = $privilege
  real_name = $name


EOTXT;

///////////////////////////////////////////////////////////////////////////////
// OPERATIONS
///////////////////////////////////////////////////////////////////////////////

$table = "user";
$args  = Array(
  "username"      => $username,
  "password"      => $password,
  "privilege"     => (int) $privilege,
  "real_name"     => $name,
  "last_session"  => "",
  "last_registry" => "",
  "created_at"    => date("%r")
);

if ( ($res = DB::Insert($table, $args)) !== false ) {
  print "User '$username' was inserted into DB.\n";
  print "You should now run 'cp -rf VFS/0 VFS/$res'";
  print "PS: Make sure to set the correct permissions to this directory, se INSTALL";
  exit(0);
} else {
  print "Failed to insert user into database!";
  exit(1);
}

?>
